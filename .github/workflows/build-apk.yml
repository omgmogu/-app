name: Build Android APK

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      version:
        description: 'APK Version'
        required: false
        default: '1.0'

jobs:
  build-apk:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Set up Java JDK
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '11'
    
    - name: Install system dependencies
      run: |
        sudo apt update -qq
        sudo apt install -y git zip unzip wget curl
        sudo apt install -y build-essential libffi-dev libssl-dev
        sudo apt install -y python3-dev python3-pip
    
    - name: Install Python dependencies
      run: |
        pip install --upgrade pip
        pip install buildozer cython==0.29.33
        pip install kivy kivymd requests pyyaml aiohttp plyer loguru
    
    - name: Set up Android SDK environment
      run: |
        echo "ANDROID_HOME=/opt/android-sdk" >> $GITHUB_ENV
        echo "ANDROID_SDK_ROOT=/opt/android-sdk" >> $GITHUB_ENV
        echo "JAVA_HOME=${JAVA_HOME}" >> $GITHUB_ENV
    
    - name: Cache buildozer dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.buildozer
          ~/.cache/pip
        key: ${{ runner.os }}-buildozer-${{ hashFiles('mobile/buildozer.spec') }}
        restore-keys: |
          ${{ runner.os }}-buildozer-
    
    - name: Build APK
      working-directory: mobile
      run: |
        # è®¾ç½®çŽ¯å¢ƒå˜é‡
        export ANDROID_HOME=/opt/android-sdk
        export ANDROID_SDK_ROOT=/opt/android-sdk
        export PATH=$PATH:$ANDROID_HOME/tools:$ANDROID_HOME/platform-tools
        
        # åˆå§‹åŒ–buildozerï¼ˆå¦‚æžœéœ€è¦ï¼‰
        if [ ! -f buildozer.spec ]; then
          buildozer init
        fi
        
        # æž„å»ºAPK
        buildozer android debug
        
        # éªŒè¯APKç”Ÿæˆ
        ls -la bin/
        if [ -f bin/*.apk ]; then
          echo "APKæž„å»ºæˆåŠŸ!"
          du -h bin/*.apk
        else
          echo "APKæž„å»ºå¤±è´¥!"
          exit 1
        fi
    
    - name: Rename APK with version
      working-directory: mobile
      run: |
        VERSION="${{ github.event.inputs.version || '1.0' }}"
        TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
        
        for apk in bin/*.apk; do
          if [ -f "$apk" ]; then
            filename=$(basename "$apk" .apk)
            new_name="é—²é±¼è‡ªåŠ¨è¯„è®ºåŠ©æ‰‹_v${VERSION}_${TIMESTAMP}.apk"
            cp "$apk" "bin/${new_name}"
            echo "APKé‡å‘½å: $apk -> bin/${new_name}"
          fi
        done
    
    - name: Upload APK artifacts
      uses: actions/upload-artifact@v3
      with:
        name: é—²é±¼è‡ªåŠ¨è¯„è®ºåŠ©æ‰‹-Android-APK
        path: |
          mobile/bin/*.apk
        retention-days: 30
    
    - name: Create Release (on tag)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: mobile/bin/*.apk
        tag_name: ${{ github.ref_name }}
        name: é—²é±¼è‡ªåŠ¨è¯„è®ºåŠ©æ‰‹ ${{ github.ref_name }}
        body: |
          ## ðŸŽ‰ é—²é±¼è‡ªåŠ¨è¯„è®ºåŠ©æ‰‹ Android APK
          
          ### ðŸ“± å®‰è£…è¯´æ˜Ž
          1. ä¸‹è½½APKæ–‡ä»¶åˆ°Androidè®¾å¤‡
          2. å¼€å¯"æœªçŸ¥æ¥æº"å®‰è£…æƒé™
          3. ç‚¹å‡»APKæ–‡ä»¶å®‰è£…
          4. æŽˆäºˆå¿…è¦æƒé™
          
          ### ðŸ“‹ ç‰ˆæœ¬ä¿¡æ¯
          - **ç‰ˆæœ¬**: ${{ github.ref_name }}
          - **æž„å»ºæ—¶é—´**: ${{ github.run_number }}
          - **æ”¯æŒç³»ç»Ÿ**: Android 6.0+ (API 23+)
          - **æž¶æž„**: armeabi-v7a, arm64-v8a
          
          ### âš ï¸ ä½¿ç”¨è¯´æ˜Ž
          - æ­¤APKä¸ºç§»åŠ¨ç«¯UIç‰ˆæœ¬
          - å®Œæ•´åŠŸèƒ½éœ€è¦é…åˆæ¡Œé¢ç‰ˆæœ¬ä½¿ç”¨
          - ä»…ä¾›å­¦ä¹ å’Œç ”ç©¶ç”¨é€”
          
          ### ðŸ”§ æŠ€æœ¯è§„æ ¼
          - åŸºäºŽ Kivy + KivyMD å¼€å‘
          - Material Design UIé£Žæ ¼
          - æ”¯æŒå¤šæž¶æž„Androidè®¾å¤‡
          - å®Œæ•´æƒé™å’Œå…¼å®¹æ€§é…ç½®
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Build summary
      run: |
        echo "## ðŸŽ¯ æž„å»ºå®Œæˆæ€»ç»“" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“± ç”Ÿæˆçš„APKæ–‡ä»¶:" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -d mobile/bin ]; then
          cd mobile/bin
          for apk in *.apk; do
            if [ -f "$apk" ]; then
              size=$(du -h "$apk" | cut -f1)
              echo "- **$apk** (${size})" >> $GITHUB_STEP_SUMMARY
            fi
          done
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”½ ä¸‹è½½æ–¹å¼:" >> $GITHUB_STEP_SUMMARY
        echo "1. ç‚¹å‡»Actionsé¡µé¢çš„æž„å»ºç»“æžœ" >> $GITHUB_STEP_SUMMARY
        echo "2. åœ¨Artifactséƒ¨åˆ†ä¸‹è½½APKæ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
        echo "3. æˆ–ç­‰å¾…Releaseè‡ªåŠ¨å‘å¸ƒ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### â° æž„å»ºæ—¶é—´: $(date)" >> $GITHUB_STEP_SUMMARY